<!DOCTYPE html>
<html lang="en">

<head>
    <title>Coinbase Crypto Couch Potato</title>
    <style>
        table {
            border-collapse: collapse;
            margin: 15px;
        }

        td,
        th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 15px;
        }

        .td-right {
            text-align: right;
        }

        tr:nth-child(even) {
            background-color: #eeeeee;
        }

        input[type="submit" i] {
            margin: 15px;
            background-color:rgb(40, 84, 231);
            border: none;
            color: white;
            padding: 15px 25px;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
        }
        input[type="submit" i]:hover {
            background-color: rgb(37, 79, 205);
        }
    </style>
</head>

<body>

    <h1>Coinbase Crypto Couch Potato</h1>

    <table>
        <tr>
            <td>Total portefolio</td>
            <td class="td-right">
                <input type="text" size="10" id="totalPortefolio" value="400"
                    oninput="onTotalPortefolioUpdated(this.value)">
            </td>
        </tr>


        <tr>
            <td>Ratio crypto</td>
            <td id="ratioCryptoTd" class="td-right">50 %</td>
        </tr>
        <tr>
            <td>Ratio cash</td>
            <td id="ratioCashTd" class="td-right">50 %</td>
        </tr>

        <tr>
                <td>Modify ratio</td>
                <td><input type="range" id="ratioRange" name="volume"
                    min="0" max="100" value="50" step="5" 
                    oninput="onRatioRange(this.value)"></td>
            </tr>

        <tr>
            <td>Total market</td>
            <td id="totalMarket" class="td-right"></td>
        </tr>
    </table>

    <form action="https://www.coinbase.com/join/wostyn_u">
        <input type="submit" formtarget="_blank" value="Create Coinbase Wallet" />
    </form>

    <table id="table">
        <tr>
            <th>#</th>
            <th>Name</th>
            <th>Market cap</th>
            <th>Weight</th>
            <th>Price</th>
            <th>Target</th>
        </tr>
    </table>

    <p>Made by Thomas Wostyn</p>

    <script>
        const BILLION = 1000000000;
        const EUROS = " \u20AC";
        const BILLION_EUROS = " B\u20AC";
        const EXCLUDE_CRYPTO_NAMES = ["Bitcoin SV", "Single Collateral Dai"];

        const URL = "https://www.coinbase.com/api/v2/assets/summary?base=EUR&filter=listed";

        const resources = [
            {
                name: "Bitcoin",
                img: "bitcoin.svg"
            },
            {
                name: "Ethereum",
                img: "ethereum.svg"
            },
            {
                name: "XRP",
                img: "xrp.svg"
            },
            {
                name: "Bitcoin Cash",
                img: "bch.svg"
            },
            {
                name: "Litecoin",
                img: "ltc.svg"
            },
            {
                name: "EOS",
                img: "eos.svg"
            },
            {
                name: "Stellar Lumens",
                img: "xlm.svg"
            },
            {
                name: "Ethereum Classic",
                img: "etc.svg"
            },
            {
                name: "Zcash",
                img: "zec.svg"
            },
            {
                name: "Tezos",
                img: "tezos.png"
            },
            {
                name: "Chainlink",
                img: "chainlink.webp"
            },
            {
                name: "USD Coin",
                img: "usdcoin.webp"
            },
            {
                name: "Basic Attention Token",
                img: "basic-attention-token.webp"
            },
            {
                name: "0x",
                img: "0x.webp"
            },
            {
                name: "Augur",
                img: "augur.webp"
            },
            {
                name: "Dai",
                img: "dai.png"
            },
            {
                name: "Dash",
                img: "dash.png"
            }
        ];

        const resourcesMap = new Map();
        resources.forEach(r => resourcesMap.set(r.name, r));

        class Crypto {
            constructor(number, cryptoJson, totalMarket, totalCrypto) {
                this.number = number;
                this.name = cryptoJson.name;
                let marketCapFloat = parseFloat(cryptoJson.market_cap);
                this.marketBillion = roundDec(marketCapFloat / BILLION, 3);
                this.priceRounded = roundDec(cryptoJson.latest, 2);
                this.weight = (marketCapFloat / totalMarket);
                let weight100 = this.weight * 100;
                this.weightDisplay = roundDec(weight100, 3);
                this.updateTotalCrypto(totalCrypto)
            }

            updateTotalCrypto(totalCrypto) {
                this.target = roundDec(totalCrypto * this.weight, 3).concat(EUROS);
            }
        }

        class CrytoController {
            constructor() {
                this.cryptos = [];

                this.totalMarket = 0;
                this.totalMarketDisplay = "";

                this.totalPortefolio = 0;
                this.ratioCrypto = 0.5;
                this.totalCrypto = 0;
            }

            addJsonCrypto(jsonCrypto, index) {
                let crypto = new Crypto(index + 1, jsonCrypto, this.totalMarket, this.totalCrypto);
                this.cryptos.push(crypto);
            }

            setTotalMarket(totalMarket) {
                this.totalMarket = totalMarket;
                this.totalMarketDisplay = roundDec(totalMarket / BILLION, 3).concat(BILLION_EUROS);
            }

            setTotalPortefolio(totalPortefolio) {
                this.totalPortefolio = totalPortefolio;
                this.computeCryptoTarget();
            }

            updateCryptoRatio(cryptoRatio) {
                this.ratioCrypto = cryptoRatio;
                this.computeCryptoTarget();
            }

            computeCryptoTarget() {
                this.totalCrypto = this.totalPortefolio * this.ratioCrypto;
                this.cryptos.forEach(c => c.updateTotalCrypto(this.totalCrypto));
            }

            target(pCryptoName) {
                return this.cryptos.filter(c => c.name == pCryptoName).map(c => c.target);
            }
        }

        let table = document.getElementById("table");
        let totalPortefolioInput = document.getElementById("totalPortefolio");

        let crytoController = new CrytoController();

        function main() {
            let xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    let data = JSON.parse(this.responseText).data.filter(availableCrytoPredicate);
                    initTable(data);
                }
            };
            xmlhttp.open("GET", URL, true);
            xmlhttp.send();
        }


        function initTable(data) {
            let totalMarket = data.map(toMarket).reduce(sum);
            crytoController.setTotalMarket(totalMarket);

            crytoController.setTotalPortefolio(totalPortefolioInput.value);

            data.forEach((jsonCrypto, index) => crytoController.addJsonCrypto(jsonCrypto, index));

            crytoController.cryptos.forEach(addCryptoToTab);
            document.getElementById("totalMarket").innerHTML = crytoController.totalMarketDisplay;
        }


        function addCryptoToTab(crypto) {
            newRow = table.insertRow(-1);
            newRow.insertCell(0).appendChild(document.createTextNode(crypto.number));

            let nameCell = newRow.insertCell(1);

            let res = resourcesMap.get(crypto.name);
            if (res != undefined) {
                let img = document.createElement("img");
                img.src = "img/" + res.img;
                img.height = "25";
                img.width = "25";
                img.style = "vertical-align:middle; padding-right: 20px;"
                nameCell.appendChild(img);
            }
            nameCell.appendChild(document.createTextNode(crypto.name));
            newRow.insertCell(2).appendChild(document.createTextNode(crypto.marketBillion.concat(BILLION_EUROS)));
            newRow.insertCell(3).appendChild(document.createTextNode(crypto.weightDisplay.concat(" %")));
            newRow.insertCell(4).appendChild(document.createTextNode(crypto.priceRounded.concat(EUROS)));
            newRow.insertCell(5).appendChild(document.createTextNode(crypto.target));

            Array.from(newRow.cells)
                .filter((cell, index) => index != 1)
                .forEach(cell => cell.style.textAlign = "right");
        }

        function roundDec(floatValue, dec) {
            let expo = Math.pow(10, dec);
            return (Math.round(floatValue * expo) / expo).toFixed(dec);
        }

        function availableCrytoPredicate(crypto) {
            return !EXCLUDE_CRYPTO_NAMES.includes(crypto.name);
        }

        function sum(e1, e2) {
            return e1 + e2;
        }

        function toMarket(crypo) {
            return parseFloat(crypo.market_cap);
        }

        function onTotalPortefolioUpdated(portefolioInput) {
            crytoController.setTotalPortefolio(parseFloat(portefolioInput) );
            updateTagetColumn();
        }

        function onRatioRange(ratioInput) {
            let cryptoRatio100 = parseFloat(ratioInput);
            let cashRatio100 = 100 - cryptoRatio100;

            document.getElementById("ratioCryptoTd").innerHTML = cryptoRatio100 + " %";
            document.getElementById("ratioCashTd").innerHTML = cashRatio100 + " %";

            let cryptoRatio = cryptoRatio100 / 100;
            crytoController.updateCryptoRatio(cryptoRatio);
            updateTagetColumn();
        }

        function updateTagetColumn() {
            Array.from(table.rows)
                .filter((row, index) => index != 0)
                .forEach(updateTarget);
        }

        function updateTarget(row) {
            let crypoName = row.cells[1].innerText;
            row.cells[5].innerHTML = crytoController.target(crypoName);
        }

        main();
    </script>

</body>

</html>